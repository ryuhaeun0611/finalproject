import streamlit as st
import base64
from pathlib import Path

# -------------------------------------------
# 기본 설정
# -------------------------------------------
st.set_page_config(
    page_title="숲가꾸기와 산불 피해",
    layout="wide"
)

st.title("🌲 숲가꾸기 활동이 산불 피해에 미치는 영향")

# -------------------------------------------
# 앱 제작자
# -------------------------------------------
st.markdown("""
### 👥 앱 제작자  
**20908 류지민 · 20909 류하은 · 20923 최보경**
""")

st.markdown("----")

# -------------------------------------------
# 한 줄 요약
# -------------------------------------------
st.markdown("""
### 🔍 한 줄 요약

**숲가꾸기·조림이 집중된 침엽수 숲 + 건조한 조건**에서는  
임도와 도로를 아무리 많이 깔아도, **대형산불을 막지 못한다**는 것이  
최근 연구들의 공통된 결론입니다.
""")

st.markdown("----")

# -------------------------------------------
# 연구 요약
# -------------------------------------------
st.markdown("""
## 1️⃣ 무엇을 근거로 말하나?

### 🧪 연구 1. 강릉 난곡동 대형산불(2023) 사례 분석

- 피해 산림 면적: **약 149ha**
- 피해지 경계 50m 이내 도로 길이: **약 59.6km**
- 도로 밀도: **168.9 m/ha (전국 평균 대비 40배 이상)**
- 도로에 의해 분절된 숲 **83개 패치 전부 전소**
- 넓은 도로·하천·제방도 **비산(ember spotting)** 때문에 방화선 역할 실패

👉 **도로망(임도 포함)이 대형산불의 확산을 막지 못했다**는 결론을 보여줍니다.

---

### 🧪 연구 2. 경상북도 1km 격자 산불 274건 통계 분석

- 경상북도 전역 1km 격자 단위로 산불 **274건**을 분석
- 로지스틱 회귀 결과:

  - **숲가꾸기·조림 비율 ↑ → 산불 발생 확률 ↑ (유의)**  
  - **침엽수 비율, 임분 밀도 ↑ → 산불 발생 위험 ↑**  
  - **상대습도, 숲의 나이(영급) ↑ → 산불 위험 ↓**  
  - **임도 접근성(임도까지 거리) → 유의하지 않음**

👉 산불은 **숲 구조(숲가꾸기·조림, 침엽수 편중, 밀도 등)** 의 영향을 더 크게 받으며,  
   임도는 “결정적인 변수”가 아니었다는 것을 보여줍니다.
""")

st.markdown("----")

# -------------------------------------------
# 메커니즘 요약
# -------------------------------------------
st.markdown("""
## 2️⃣ 왜 이런 일이 벌어질까? (메커니즘)

### 🌿 1. 숲가꾸기 → 하층식생 제거 → 숲 내부 습도 감소

- 숲가꾸기·조림 과정에서 **활엽수 하층식생, 관목, 풀층**이 함께 제거됩니다.
- 원래 하층식생은
  - 토양 수분을 붙잡고,
  - 그늘을 만들어 **숲 내부 습도 유지**,
  - 연료(가지·낙엽)가 한 덩어리로 이어지지 않도록 **완충 역할**을 합니다.
- 하층이 사라지면:
  - 햇빛·바람이 지면까지 바로 도달 → 낙엽·토양이 **빠르게 건조**
  - 건조한 연료층이 균질하게 이어진 **‘잘 타는 숲’**이 만들어집니다.

> 숲가꾸기 → 하층식생 제거 → 내부 습도 감소 → 발화·확산에 유리한 조건 형성

---

### 🌲 2. 침엽수 편중 + 높은 임분 밀도

- 소나무 등 침엽수는
  - 기름기가 많은 수지,
  - 잘 마르는 침엽 낙엽 덕분에 **가연성이 높고**
  - 수관이 이어져 있으면 **수관화**로 번지기 쉽습니다.
- 숲가꾸기가 **침엽수 위주의 촘촘한 구조를 근본적으로 바꾸지 못하면**,  
  결과적으로 **‘정돈된 고연료 숲’**이 됩니다.

---

### 🛣️ 3. 도로·임도는 왜 방패가 되지 못했나?

- 강릉 사례에서는:
  - 넓은 도로·하천·제방까지도 **비산(ember)이 수십~수백 m를 날아 넘어감**
  - 피해 숲 상당수가 도로에서 매우 가까운 곳에 위치
- 즉, 대형산불·강풍 상황에서는
  - 도로 폭 몇 m로는 **불씨를 막기에 턱없이 부족**하고,
  - 도로망이 촘촘해도 **피해 강도를 줄였다는 증거는 거의 없음**.

👉 “임도를 늘리면 산불을 쉽게 진화할 수 있다”는 통념이  
   실제 데이터에서는 잘 뒷받침되지 않습니다.
""")

st.markdown("----")

# -------------------------------------------
# 앱 구성 안내
# -------------------------------------------
st.markdown("""
## 3️⃣ 이 앱에서 볼 수 있는 것 👀

1. **다중 변수 기반 산불 피해 시뮬레이션**  
   - 숲가꾸기 밀도, 침엽수 비율, 임분 밀도, 습도, 경사도 등의 조합을 바꿔 보며  
     산불 피해 면적이 어떻게 변하는지 시뮬레이션합니다.

2. **지역별 산불 피해 분석(클러스터링)**  
   - 전처리된 `region_df.csv`를 업로드하면,  
     **표준화 + 유클리드 거리 기반 클러스터링**으로  
     비슷한 산불 구조를 가진 지역끼리 묶어 볼 수 있습니다.

👉 왼쪽 **Pages 메뉴**에서 각 페이지를 선택해 탐색해 보세요.
""")

st.markdown("----")

# -------------------------------------------
# PDF 표시용 함수
# -------------------------------------------
BASE_DIR = Path(__file__).parent  # main.py가 있는 폴더 기준

def display_pdf_from_local(rel_path: str, title: str, height: int = 700):
    """리포지토리 내부 PDF를 iframe으로 띄우는 함수"""
    pdf_path = BASE_DIR / rel_path

    st.subheader(title)
    st.caption(f"`{rel_path}` 에서 파일을 불러옵니다.")

    if not pdf_path.exists():
        st.warning(f"⚠ `{pdf_path}` 파일이 존재하지 않습니다. 경로와 파일명을 확인해 주세요.")
        return

    with pdf_path.open("rb") as f:
        base64_pdf = base64.b64encode(f.read()).decode("utf-8")

    pdf_display = f"""
    <iframe
        src="data:application/pdf;base64,{base64_pdf}"
        width="100%"
        height="{height}px"
        type="application/pdf">
    </iframe>
    """
    st.markdown(pdf_display, unsafe_allow_html=True)

# -------------------------------------------
# 하단: PDF 직접 열람 섹션
# -------------------------------------------
st.markdown("## 📄 참고한 연구자료 직접 보기")

col1, col2 = st.columns(2)

with col1:
    display_pdf_from_local(
        "pdf/road_fire.pdf",         # pdf 폴더 안 파일명과 정확히 일치
        "🔍 연구 1: 산림 내 도로 확대와 대형산불"
    )

with col2:
    display_pdf_from_local(
        "pdf/forest_road_fire.pdf",  # pdf 폴더 안 파일명과 정확히 일치
        "🌲 연구 2: 임도·산림경영이 산불 발생에 미치는 영향"
    )
