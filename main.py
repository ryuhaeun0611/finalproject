import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from sklearn.linear_model import LinearRegression
from sklearn.ensemble import RandomForestRegressor
import shap
import matplotlib.pyplot as plt

# -------------------------------------------------------------------
# ğŸ”§ ì£¼ìš” ê°œì„  ì‚¬í•­
# 1) ì˜ˆì‹œ ë°ì´í„° êµ¬ì¡°ë¥¼ ë…¼ë¬¸ ê²°ê³¼ì— ë§ì¶° ì¬êµ¬ì„±
#    - forest_care_density(ìˆ²ê°€ê¾¸ê¸°/ì¡°ë¦¼ ë°€ë„) â†‘ â†’ fire_damage_area â†‘
#    - conifer_ratio(ì¹¨ì—½ìˆ˜ ë¹„ìœ¨), stand_density(ì„ë¶„ ë°€ë„) â†‘ â†’ í”¼í•´ ì¦ê°€
#    - humidity(ìƒëŒ€ìŠµë„) â†‘ â†’ í”¼í•´ ê°ì†Œ
# 2) "ìˆ²ê°€ê¾¸ê¸° í™œë™ì´ ë§ì„ìˆ˜ë¡ í”¼í•´ê°€ ì»¤ì§„ë‹¤"ë¥¼
#    - ì‚°ì ë„ + íšŒê·€ ì§ì„  + ì‚¬ìš©ìì˜ í˜„ì¬ ì…ë ¥ì  ìœ¼ë¡œ ì‹œê°ì ìœ¼ë¡œ ê°•ì¡°
# 3) SHAP summary plotê³¼ í•¨ê»˜
#    - forest_care_densityì˜ í‰ê· ì  ì¤‘ìš”ë„ê°€ ë†’ê²Œ ë‚˜ì˜¤ë„ë¡ ë°ì´í„° êµ¬ì„±
# 4) ì„ë„ ì ‘ê·¼ì„± ë³€ìˆ˜ëŠ” ì—°êµ¬ê²°ê³¼ìƒ ì˜í–¥ì´ ì—†ìœ¼ë¯€ë¡œ ëª¨ë¸ì—ì„œ ì œì™¸(ì„¤ëª…ë§Œ ì–¸ê¸‰)
# -------------------------------------------------------------------

st.set_page_config(page_title="ì‚°ë¶ˆ í”¼í•´ ì‹œë®¬ë ˆì´ì…˜", layout="wide")
st.title("ğŸŒ² ë‹¤ì¤‘ ë³€ìˆ˜ ê¸°ë°˜ ì‚°ë¶ˆ í”¼í•´ ì˜ˆì¸¡ ì‹œë®¬ë ˆì´ì…˜")

st.markdown("""
ì´ ì•±ì€ **ìˆ²ê°€ê¾¸ê¸°(ì¡°ë¦¼Â·ìˆ²ê°€ê¾¸ê¸° ë©´ì /ë°€ë„)**, **ìˆ˜ì¢… êµ¬ì„±(ì¹¨ì—½ìˆ˜ ë¹„ìœ¨)**,  
**ìˆ˜ê´€ ë°€ë„**, **ì§€í˜•(ê²½ì‚¬ë„)**, **ì„ë¶„ ë°€ë„**, **ìŠµë„** ë“±ì´  
ì‚°ë¶ˆ **í”¼í•´ ë©´ì (ha)** ì— ì–´ë–¤ ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆëŠ”ì§€ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.

ì—…ë¡œë“œí•œ ë…¼ë¬¸Â·í†µê³„ìë£Œì—ì„œ ê³µí†µì ìœ¼ë¡œ ë‚˜íƒ€ë‚œ ê²½í–¥ì„ ë°˜ì˜í•˜ì—¬,

- ìˆ²ê°€ê¾¸ê¸°/ì¡°ë¦¼ ë°€ë„ê°€ ë†’ì„ìˆ˜ë¡ â†’ ì‚°ë¶ˆ í”¼í•´ê°€ **ì¦ê°€**í•˜ê³   
- ì¹¨ì—½ìˆ˜ ë¹„ìœ¨Â·ì„ë¶„ ë°€ë„ê°€ ë†’ì„ìˆ˜ë¡ â†’ ì‚°ë¶ˆ í”¼í•´ê°€ **ì¦ê°€**í•˜ë©°  
- ìŠµë„ê°€ ë†’ì„ìˆ˜ë¡ â†’ ì‚°ë¶ˆ í”¼í•´ê°€ **ê°ì†Œ**í•˜ëŠ”

ë°©í–¥ìœ¼ë¡œ ì˜ˆì‹œ ë°ì´í„°ë¥¼ êµ¬ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.
""")

st.info(
    "â€» ì„ë„ ì ‘ê·¼ì„± ë³€ìˆ˜ëŠ” ê²½ë¶ ë¶„ì„ ë° ê°•ë¦‰ ë‚œê³¡ ì‚¬ë¡€ ì—°êµ¬ì—ì„œ "
    "`ì‚°ë¶ˆ ë°œìƒÂ·í”¼í•´ì™€ í†µê³„ì ìœ¼ë¡œ ìœ ì˜í•œ ê´€ë ¨ì´ ì—†ìŒ`ìœ¼ë¡œ ë‚˜íƒ€ë‚˜, "
    "ë³¸ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë¸ì—ì„œëŠ” ì œì™¸í•˜ê³  ì„¤ëª…ë§Œ ì œê³µí•©ë‹ˆë‹¤."
)

# -------------------------------------------------------------------
# 1. ì˜ˆì‹œ ë°ì´í„° (ì—°êµ¬ê²°ê³¼ë¥¼ ë°˜ì˜í•œ ê°€ìƒ ë°ì´í„°)
#    - ê°’ ìì²´ëŠ” ê°€ìƒì´ë‚˜, ë³€ìˆ˜ ê°„ ê´€ê³„ëŠ” ë…¼ë¬¸ ê²°ê³¼ì™€ ì¼ê´€ë˜ê²Œ êµ¬ì„±
# -------------------------------------------------------------------
data = {
    # ìˆ²ê°€ê¾¸ê¸°/ì¡°ë¦¼ ë°€ë„ (ì˜ˆ: ha/ã¢ ë˜ëŠ” 0~1 ìŠ¤ì¼€ì¼)
    'forest_care_density': [0.10, 0.12, 0.15, 0.18, 0.20, 0.25, 0.28, 0.30, 0.32, 0.35,
                            0.38, 0.40, 0.42, 0.45, 0.48, 0.50, 0.55, 0.60, 0.65, 0.70],
    # ìˆ˜ê´€ë°€ë„ (0~1) â€“ ë„ˆë¬´ ë‚®ê±°ë‚˜ ë„ˆë¬´ ë†’ìœ¼ë©´ í”¼í•´ê°€ ì»¤ì§€ëŠ” íŒ¨í„´ì„ ì¼ë¶€ ë°˜ì˜
    'canopy_density':      [0.55, 0.60, 0.62, 0.65, 0.68, 0.70, 0.72, 0.74, 0.76, 0.78,
                            0.80, 0.82, 0.84, 0.86, 0.88, 0.90, 0.92, 0.93, 0.94, 0.95],
    # ì¹¨ì—½ìˆ˜ ë¹„ìœ¨ (0~1)
    'conifer_ratio':       [0.30, 0.32, 0.35, 0.38, 0.40, 0.45, 0.48, 0.50, 0.52, 0.55,
                            0.58, 0.60, 0.62, 0.64, 0.66, 0.68, 0.70, 0.72, 0.75, 0.78],
    # í‰ê·  ê²½ì‚¬ë„ (ë„)
    'slope_degree':        [5, 7, 10, 12, 15, 18, 20, 22, 24, 26,
                            28, 30, 32, 34, 36, 38, 40, 42, 43, 45],
    # ì„ë¶„ ë°€ë„ (0~1)
    'stand_density':       [0.40, 0.42, 0.45, 0.48, 0.50, 0.52, 0.55, 0.58, 0.60, 0.62,
                            0.64, 0.66, 0.68, 0.70, 0.72, 0.74, 0.76, 0.78, 0.80, 0.82],
    # ìƒëŒ€ìŠµë„(%)
    'humidity':            [70, 68, 72, 65, 63, 60, 58, 55, 53, 50,
                            48, 45, 43, 40, 38, 35, 33, 30, 28, 25],
}

df = pd.DataFrame(data)

# í”¼í•´ ë©´ì  ìƒì„±: ì—°êµ¬ ê²°ê³¼ ë°©í–¥ì„±ì„ ë°˜ì˜í•œ ê°€ìƒì˜ í•¨ìˆ˜ + ì•½ê°„ì˜ ë…¸ì´ì¦ˆ
# (ìˆ²ê°€ê¾¸ê¸° ë°€ë„, ì¹¨ì—½ìˆ˜ ë¹„ìœ¨, ì„ë¶„ ë°€ë„ëŠ” +, ìŠµë„ëŠ” -)
rng = np.random.default_rng(42)
base = (
    500
    + 9000 * df['forest_care_density']      # ìˆ²ê°€ê¾¸ê¸° íš¨ê³¼ (ì–‘ì˜ ì˜í–¥)
    + 8000 * df['conifer_ratio']            # ì¹¨ì—½ìˆ˜ ë¹„ìœ¨ (ì–‘ì˜ ì˜í–¥)
    + 6000 * df['stand_density']            # ì„ë¶„ ë°€ë„ (ì–‘ì˜ ì˜í–¥)
    + 20   * df['slope_degree']             # ê²½ì‚¬ë„ (ì™„ë§Œí•œ ì–‘ì˜ ì˜í–¥)
    - 30   * df['humidity']                 # ìŠµë„ (ìŒì˜ ì˜í–¥)
)
noise = rng.normal(0, 400, size=len(df))
df['fire_damage_area'] = np.clip(base + noise, 50, None)  # ìµœì†Œ 50ha ì´ìƒìœ¼ë¡œ clip

# -------------------------------------------------------------------
# 2. íŠ¹ì§• ë° íƒ€ê²Ÿ ì„¤ì •
# -------------------------------------------------------------------
features = ['forest_care_density', 'canopy_density', 'conifer_ratio',
            'slope_degree', 'stand_density', 'humidity']
X = df[features]
y = df['fire_damage_area']

# ëª¨ë¸ í•™ìŠµ
reg_model = LinearRegression().fit(X, y)
rf_model = RandomForestRegressor(
    random_state=42,
    n_estimators=300,
    max_depth=5
).fit(X, y)

# -------------------------------------------------------------------
# 3. ì‚¬ì´ë“œë°” ì…ë ¥ (ì‚¬ìš©ìê°€ ê°€ì •í•˜ëŠ” ì‚°ë¦¼ ìƒíƒœ)
# -------------------------------------------------------------------
st.sidebar.header("ğŸ§ª ì‹œë®¬ë ˆì´ì…˜ ì…ë ¥")

forest_input = st.sidebar.slider("ìˆ²ê°€ê¾¸ê¸°/ì¡°ë¦¼ ë°€ë„ (0~0.8)", 0.05, 0.80, 0.40, step=0.01)
canopy_input = st.sidebar.slider("ìˆ˜ê´€ ë°€ë„ (0~1)", 0.3, 1.0, 0.75, step=0.01)
species_input = st.sidebar.slider("ì¹¨ì—½ìˆ˜ ë¹„ìœ¨ (0~1)", 0.0, 1.0, 0.55, step=0.01)
slope_input = st.sidebar.slider("í‰ê·  ê²½ì‚¬ë„ (ë„)", 0, 45, 25, step=1)
stand_input = st.sidebar.slider("ì„ë¶„ ë°€ë„ (0~1)", 0.2, 1.0, 0.65, step=0.01)
humidity_input = st.sidebar.slider("ìƒëŒ€ìŠµë„ (%)", 10, 100, 40, step=1)

# ì…ë ¥ ë°°ì—´ ìƒì„±
input_array = np.array([[forest_input, canopy_input, species_input,
                         slope_input, stand_input, humidity_input]])

# ì˜ˆì¸¡
reg_pred = reg_model.predict(input_array)[0]
rf_pred = rf_model.predict(input_array)[0]

# -------------------------------------------------------------------
# 4. ì˜ˆì¸¡ ê²°ê³¼ ì¶œë ¥
# -------------------------------------------------------------------
st.subheader("ğŸ“Š ì˜ˆì¸¡ ê²°ê³¼")
col1, col2 = st.columns(2)
with col1:
    st.metric("ë‹¤ì¤‘íšŒê·€ ì˜ˆì¸¡ ì‚°ë¶ˆ í”¼í•´ ë©´ì  (ha)", f"{reg_pred:,.0f}")
with col2:
    st.metric("ëœë¤í¬ë ˆìŠ¤íŠ¸ ì˜ˆì¸¡ ì‚°ë¶ˆ í”¼í•´ ë©´ì  (ha)", f"{rf_pred:,.0f}")

st.caption(
    "â€» ìˆ˜ì¹˜ëŠ” ì—°êµ¬ê²°ê³¼ì˜ 'ë°©í–¥ì„±'ì„ ì‹œë®¬ë ˆì´ì…˜í•˜ê¸° ìœ„í•œ ê°€ìƒì˜ ê°’ì´ë©°, "
    "ì‹¤ì œ í”¼í•´ ê·œëª¨ë¥¼ ê·¸ëŒ€ë¡œ ë°˜ì˜í•˜ëŠ” ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤."
)

# -------------------------------------------------------------------
# 5. ì‹œê°í™” 1: ìˆ²ê°€ê¾¸ê¸° í™œë™ì´ ë§ì„ìˆ˜ë¡ í”¼í•´ê°€ ì»¤ì§€ëŠ”ì§€ í™•ì¸
#    - ì‹¤ì œ(ì˜ˆì‹œ) ë°ì´í„° + íšŒê·€ ì§ì„  + ì‚¬ìš©ì ì…ë ¥ì 
# -------------------------------------------------------------------
st.subheader("ğŸŒ² ìˆ²ê°€ê¾¸ê¸°/ì¡°ë¦¼ ë°€ë„ì™€ ì‚°ë¶ˆ í”¼í•´ ë©´ì ì˜ ê´€ê³„")

# íšŒê·€ ì§ì„ ì„ ê·¸ë¦¬ê¸° ìœ„í•´ forest_careë§Œ ë³€í™”ì‹œí‚¤ê³  ë‚˜ë¨¸ì§€ëŠ” í‰ê· ê°’ìœ¼ë¡œ ê³ ì •
forest_range = np.linspace(df['forest_care_density'].min(),
                           df['forest_care_density'].max(), 50)
X_line = pd.DataFrame({
    'forest_care_density': forest_range,
    'canopy_density': np.full_like(forest_range, df['canopy_density'].mean()),
    'conifer_ratio': np.full_like(forest_range, df['conifer_ratio'].mean()),
    'slope_degree': np.full_like(forest_range, df['slope_degree'].mean()),
    'stand_density': np.full_like(forest_range, df['stand_density'].mean()),
    'humidity': np.full_like(forest_range, df['humidity'].mean()),
})
line_pred = reg_model.predict(X_line)

fig1 = go.Figure()

# â‘  ì˜ˆì‹œ ë°ì´í„° ì‚°ì ë„
fig1.add_trace(go.Scatter(
    x=df['forest_care_density'],
    y=df['fire_damage_area'],
    mode='markers',
    name='ì˜ˆì‹œ ê´€ì¸¡ê°’',
    marker=dict(size=8)
))

# â‘¡ íšŒê·€ ì§ì„ 
fig1.add_trace(go.Scatter(
    x=forest_range,
    y=line_pred,
    mode='lines',
    name='ì„ í˜•íšŒê·€ ì¶”ì„¸ì„ ',
    line=dict(width=3, dash='solid')
))

# â‘¢ ì‚¬ìš©ìì˜ í˜„ì¬ ì…ë ¥ì 
fig1.add_trace(go.Scatter(
    x=[forest_input],
    y=[rf_pred],
    mode='markers',
    name='í˜„ì¬ ì‹œë‚˜ë¦¬ì˜¤(RF ì˜ˆì¸¡)',
    marker=dict(size=12, symbol='star')
))

fig1.update_layout(
    title="ìˆ²ê°€ê¾¸ê¸°/ì¡°ë¦¼ ë°€ë„ ì¦ê°€ì— ë”°ë¥¸ ì‚°ë¶ˆ í”¼í•´ ë©´ì  ë³€í™” (ë‹¤ë¥¸ ë³€ìˆ˜ í‰ê·  ê³ ì •)",
    xaxis_title="ìˆ²ê°€ê¾¸ê¸°/ì¡°ë¦¼ ë°€ë„ (0~0.8, ìƒëŒ€ê°’)",
    yaxis_title="ì‚°ë¶ˆ í”¼í•´ ë©´ì  (ha)",
    legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1)
)
st.plotly_chart(fig1, use_container_width=True)

st.markdown("""
ìœ„ ê·¸ë˜í”„ì—ì„œ **ìˆ²ê°€ê¾¸ê¸°/ì¡°ë¦¼ ë°€ë„ê°€ ì˜¤ë¥¸ìª½(0.7 ê·¼ì²˜)ìœ¼ë¡œ ê°ˆìˆ˜ë¡ íšŒê·€ ì§ì„ ì´ ëšœë ·í•˜ê²Œ ìƒìŠ¹**í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
ì´ëŠ” ì—…ë¡œë“œëœ ì—°êµ¬ ê²°ê³¼ì™€ ë§ˆì°¬ê°€ì§€ë¡œ **â€œìˆ²ê°€ê¾¸ê¸° í™œë™ì´ ì§‘ì¤‘ëœ ì§€ì—­ì¼ìˆ˜ë¡ ì‚°ë¶ˆ í”¼í•´ê°€ ì»¤ì§€ëŠ” ê²½í–¥â€**ì„
ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆê²Œ í•´ ì¤ë‹ˆë‹¤.
""")

# -------------------------------------------------------------------
# 6. ì‹œê°í™” 2: ë‹¤ë¥¸ ë³€ìˆ˜ë“¤ì„ í¬í•¨í•œ SHAP ë¶„ì„
# -------------------------------------------------------------------
st.subheader("ğŸ” ë³€ìˆ˜ ì˜í–¥ë ¥ ë¶„ì„ (SHAP)")

# Tree ê¸°ë°˜ ëª¨ë¸ì´ë¯€ë¡œ TreeExplainer ì‚¬ìš©
explainer = shap.Explainer(rf_model, X)
# additivity ì²´í¬ ë„ê¸°
shap_values = explainer(X, check_additivity=False)

st.markdown("**(1) ì „ì²´ ë°ì´í„° ê¸°ì¤€ ë³€ìˆ˜ ì¤‘ìš”ë„ â€“ forest_care_densityê°€ ìƒë‹¨ì— ì˜¤ëŠ”ì§€ í™•ì¸í•´ ë³´ì„¸ìš”.**")

fig_summary, ax = plt.subplots()
shap.summary_plot(shap_values, X, plot_type="bar", show=False)
st.pyplot(fig_summary)

st.markdown("**(2) í˜„ì¬ ì…ë ¥ê°’ì— ëŒ€í•œ ë³€ìˆ˜ë³„ ê¸°ì—¬ë„**")

sample_df = pd.DataFrame(input_array, columns=features)
sample_shap = explainer(sample_df, check_additivity=False)
shap_vals = sample_shap.values[0]

for i, f in enumerate(features):
    st.write(f"- {f}: ì˜í–¥ë ¥ {shap_vals[i]:+.2f}")

# -------------------------------------------------------------------
# 7. ì›ë³¸(ì˜ˆì‹œ) ë°ì´í„° í…Œì´ë¸”
# -------------------------------------------------------------------
with st.expander("ğŸ“‚ í•™ìŠµì— ì‚¬ìš©ëœ ì˜ˆì‹œ ë°ì´í„° ë³´ê¸°"):
    st.dataframe(df.style.format({"fire_damage_area": "{:.1f}"}))

# -------------------------------------------------------------------
# 8. ë¶€ê°€ ì„¤ëª…
# -------------------------------------------------------------------
st.markdown("""
### ğŸ“Œ í•´ì„ ê°€ì´ë“œ

- ê·¸ë˜í”„ì™€ SHAP ê²°ê³¼ì—ì„œ **`forest_care_density`ì˜ ê¸°ìš¸ê¸°ì™€ ì¤‘ìš”ë„ê°€ í¬ê³  ì–‘(+)ì˜ ë°©í–¥**ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ë©´  
  â†’ *í˜„ì¬ì˜ ìˆ²ê°€ê¾¸ê¸°Â·ì¡°ë¦¼ ë°©ì‹ì´ ì‚°ë¶ˆ í”¼í•´ë¥¼ ì¤„ì´ê¸°ë³´ë‹¤ëŠ” ëŠ˜ë¦¬ëŠ” ìª½ìœ¼ë¡œ ì‘ìš©í•  ìˆ˜ ìˆë‹¤*ëŠ” ì—°êµ¬ ê²°ê³¼ì™€ ì¼ì¹˜í•©ë‹ˆë‹¤.

- ë°˜ëŒ€ë¡œ **humidity(ìŠµë„)**ëŠ” ìŒ(-)ì˜ ê¸°ì—¬ë¥¼ ë³´ì—¬ì•¼ í•˜ë©°,  
  **conifer_ratio(ì¹¨ì—½ìˆ˜ ë¹„ìœ¨)**, **stand_density(ì„ë¶„ ë°€ë„)**ëŠ” ì–‘(+)ì˜ ë°©í–¥ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ëŠ”ì§€ í™•ì¸í•´ ë³´ì„¸ìš”.
""")
